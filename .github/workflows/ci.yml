name: CI ThingsBoard

on:
  push:
    branches: ["**"]

jobs:
  tests-common:
    name: Tests common/data et common/util
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run ONLY common tests
        run: |
          mvn test -pl common/data,common/util -am \
            -Dlicense.skip=true \
            -Dcheckstyle.skip=true \
            -Dformatter.skip=true \
            -Dimpsort.skip=true

  docker-run:
    name: Build & Run ThingsBoard (from THIS repo)
    needs: tests-common
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build ThingsBoard (no tests)
        run: |
          mvn clean install -DskipTests \
            -Dlicense.skip=true \
            -Dcheckstyle.skip=true \
            -Dformatter.skip=true \
            -Dimpsort.skip=true

      - name: Build Docker image from this repo
        run: |
          docker build -t tb-local -f docker/tb-postgres/Dockerfile .

      - name: Start ThingsBoard with Docker Compose (Postgres)
        run: |
          cd docker && TB_IMAGE=tb-local \
          docker compose -f docker-compose.postgres.yml up -d

      - name: Check running container
        run: |
          docker ps
          cd docker && docker compose -f docker-compose.postgres.yml down