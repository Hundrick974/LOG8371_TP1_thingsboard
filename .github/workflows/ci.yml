name: CI ThingsBoard

on:
  push:

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Run tests
        run: |
          mvn test \
            -pl common/data,common/util \
            -am \
            -Dlicense.skip=true \
            -Dcheckstyle.skip=true \
            -Dformatter.skip=true \
            -Dimpsort.skip=true

      - name: Build msa/tb (skip tests) to generate docker-postgres Dockerfile
        run: |
          mvn clean install -T 1C \
            -DskipTests \
            -pl msa/tb -am \
            -Dlicense.skip=true

      - name: Verify generated Dockerfile exists
        run: |
          ls -la msa/tb/target/docker-postgres
          test -f msa/tb/target/docker-postgres/Dockerfile

      - name: Build ThingsBoard image (generated Dockerfile)
        run: |
          docker build -t thingsboard/tb:local \
            -f msa/tb/target/docker-postgres/Dockerfile \
            msa/tb/target/docker-postgres

      - name: Run ThingsBoard (smoke)
        run: |
          docker rm -f thingsboard-local || true
          docker run --name thingsboard-local -d -p 9090:9090 thingsboard/tb:local

      - name: Wait for ThingsBoard
        run: |
          echo "Waiting for ThingsBoard..."
          for i in {1..60}; do
            if curl -sf http://localhost:9090 > /dev/null; then
              echo "ThingsBoard is up"
              exit 0
            fi
            sleep 5
          done
          echo "ThingsBoard did not start"
          docker logs thingsboard-local || true
          exit 1

      - name: Cleanup
        if: always()
        run: docker rm -f thingsboard-local || true